{
    "annotations": {
        "list": [
            {
                "$$hashKey": "object:948",
                "builtIn": 1,
                "datasource": {
                    "type": "datasource",
                    "uid": "grafana"
                },
                "enable": true,
                "hide": true,
                "iconColor": "rgba(0, 211, 255, 1)",
                "name": "Annotations & Alerts",
                "type": "dashboard"
            }
        ]
    },
    "description": "Airflow 모니터링 대시보드",
    "editable": true,
    "fiscalYearStartMonth": 0,
    "gnetId": 14448,
    "graphTooltip": 0,
    "id": 1,
    "links": [],
    "liveNow": false,
    "panels": [
        {
            "datasource": {
                "type": "postgres",
                "uid": "PFAE57465A1C8801A"
            },
            "fieldConfig": {
                "defaults": {
                    "color": {
                        "mode": "thresholds"
                    },
                    "custom": {
                        "align": "center",
                        "cellOptions": {
                            "type": "color-text"
                        },
                        "filterable": false,
                        "inspect": false
                    },
                    "mappings": [
                        {
                            "options": {
                                "fail": {
                                    "color": "red",
                                    "index": 5,
                                    "text": "작업 실패"
                                },
                                "false": {
                                    "color": "text",
                                    "index": 0,
                                    "text": "-"
                                },
                                "queued": {
                                    "color": "orange",
                                    "index": 2,
                                    "text": "큐잉 완료"
                                },
                                "removed": {
                                    "color": "purple",
                                    "index": 6,
                                    "text": "삭제됨"
                                },
                                "running": {
                                    "color": "blue",
                                    "index": 3,
                                    "text": "실행 중"
                                },
                                "scheduled": {
                                    "color": "yellow",
                                    "index": 1,
                                    "text": "스케줄링 완료"
                                },
                                "skipped": {
                                    "color": "text",
                                    "index": 7,
                                    "text": "건너뜀"
                                },
                                "success": {
                                    "color": "green",
                                    "index": 4,
                                    "text": "작업 성공"
                                }
                            },
                            "type": "value"
                        }
                    ],
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "text",
                                "value": null
                            }
                        ]
                    }
                },
                "overrides": [
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "terraform_download"
                        },
                        "properties": [
                            {
                                "id": "custom.width",
                                "value": 172
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "run_id\\task_id"
                        },
                        "properties": [
                            {
                                "id": "custom.width",
                                "value": 363
                            }
                        ]
                    }
                ]
            },
            "gridPos": {
                "h": 8,
                "w": 24,
                "x": 0,
                "y": 0
            },
            "id": 13,
            "options": {
                "cellHeight": "sm",
                "footer": {
                    "countRows": false,
                    "enablePagination": false,
                    "fields": "",
                    "reducer": [
                        "sum"
                    ],
                    "show": false
                },
                "showHeader": true,
                "sortBy": []
            },
            "pluginVersion": "9.5.1",
            "targets": [
                {
                    "datasource": {
                        "type": "postgres",
                        "uid": "PFAE57465A1C8801A"
                    },
                    "editorMode": "code",
                    "format": "table",
                    "rawQuery": true,
                    "rawSql": "SELECT * FROM task_instance ORDER BY start_date DESC",
                    "refId": "A",
                    "sql": {
                        "columns": [
                            {
                                "parameters": [
                                    {
                                        "name": "*",
                                        "type": "functionParameter"
                                    }
                                ],
                                "type": "function"
                            }
                        ],
                        "groupBy": [
                            {
                                "property": {
                                    "type": "string"
                                },
                                "type": "groupBy"
                            }
                        ],
                        "limit": 50,
                        "orderBy": {
                            "property": {
                                "name": "start_date",
                                "type": "string"
                            },
                            "type": "property"
                        }
                    },
                    "table": "task_instance"
                }
            ],
            "title": "배포 작업 현황",
            "transformations": [
                {
                    "id": "groupingToMatrix",
                    "options": {
                        "columnField": "task_id",
                        "emptyValue": "false",
                        "rowField": "run_id",
                        "valueField": "state"
                    }
                },
                {
                    "id": "organize",
                    "options": {
                        "excludeByName": {},
                        "indexByName": {
                            "alb.apply": 61,
                            "alb.check": 56,
                            "alb.copy": 58,
                            "alb.plan": 60,
                            "alb.skip": 57,
                            "alb.storage_and_creds": 59,
                            "bastion.apply": 55,
                            "bastion.check": 50,
                            "bastion.copy": 52,
                            "bastion.plan": 54,
                            "bastion.skip": 51,
                            "bastion.storage_and_creds": 53,
                            "key_pair.apply": 49,
                            "key_pair.check": 44,
                            "key_pair.copy": 46,
                            "key_pair.plan": 48,
                            "key_pair.skip": 45,
                            "key_pair.storage_and_creds": 47,
                            "nat_gateway.apply": 25,
                            "nat_gateway.check": 20,
                            "nat_gateway.copy": 22,
                            "nat_gateway.plan": 24,
                            "nat_gateway.skip": 21,
                            "nat_gateway.storage_and_creds": 23,
                            "route_rule.apply": 37,
                            "route_rule.check": 32,
                            "route_rule.copy": 34,
                            "route_rule.plan": 36,
                            "route_rule.skip": 33,
                            "route_rule.storage_and_creds": 35,
                            "route_table.apply": 31,
                            "route_table.check": 26,
                            "route_table.copy": 28,
                            "route_table.plan": 30,
                            "route_table.skip": 27,
                            "route_table.storage_and_creds": 29,
                            "route_table_association.apply": 43,
                            "route_table_association.check": 38,
                            "route_table_association.copy": 40,
                            "route_table_association.plan": 42,
                            "route_table_association.skip": 39,
                            "route_table_association.storage_and_creds": 41,
                            "run_id\\task_id": 0,
                            "security_group.apply": 19,
                            "security_group.check": 14,
                            "security_group.copy": 16,
                            "security_group.plan": 18,
                            "security_group.skip": 15,
                            "security_group.storage_and_creds": 17,
                            "subnet.apply": 13,
                            "subnet.check": 8,
                            "subnet.copy": 10,
                            "subnet.plan": 12,
                            "subnet.skip": 9,
                            "subnet.storage_and_creds": 11,
                            "terraform_download": 1,
                            "vpc.apply": 7,
                            "vpc.check": 2,
                            "vpc.copy": 4,
                            "vpc.plan": 6,
                            "vpc.skip": 3,
                            "vpc.storage_and_creds": 5
                        },
                        "renameByName": {
                            "run_id\\task_id": "",
                            "task_5": ""
                        }
                    }
                }
            ],
            "type": "table"
        },
        {
            "datasource": {
                "type": "postgres",
                "uid": "PFAE57465A1C8801A"
            },
            "fieldConfig": {
                "defaults": {
                    "mappings": [
                        {
                            "options": {
                                "": {
                                    "text": ""
                                }
                            },
                            "type": "value"
                        }
                    ],
                    "max": 1,
                    "min": 0,
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "semi-dark-green",
                                "value": null
                            },
                            {
                                "color": "semi-dark-yellow",
                                "value": 35
                            },
                            {
                                "color": "semi-dark-red",
                                "value": 70
                            }
                        ]
                    },
                    "unit": "percentunit"
                },
                "overrides": []
            },
            "gridPos": {
                "h": 2,
                "w": 24,
                "x": 0,
                "y": 8
            },
            "id": 12,
            "options": {
                "displayMode": "lcd",
                "minVizHeight": 10,
                "minVizWidth": 0,
                "orientation": "horizontal",
                "reduceOptions": {
                    "calcs": [
                        "last"
                    ],
                    "fields": "",
                    "values": true
                },
                "showUnfilled": true,
                "text": {},
                "valueMode": "color"
            },
            "pluginVersion": "9.5.1",
            "targets": [
                {
                    "datasource": "AirflowDB",
                    "editorMode": "code",
                    "format": "table",
                    "group": [],
                    "hide": false,
                    "metricColumn": "none",
                    "rawQuery": true,
                    "rawSql": "with \r\ndags_processar as (\r\n\tselect * from public.dag where dag_id in ($Dags)\r\n),\r\ntask_avg as (\r\n\t-- media de duracao por task\r\n\tselect ti.dag_id, ti.task_id, round(avg(ti.duration)) avg_duration_seconds, count(1) total_execution_times \r\n\tfrom dags_processar dp \r\n\tinner join task_instance  ti on ti.dag_id  = dp.dag_id\r\n\twhere ti.start_date  >= start_date -  interval '60 day'\r\n\tand   ti.state  = 'success'\r\n\tgroup by ti.dag_id, ti.task_id\r\n\torder by 1, 2\r\n),\r\ntmp as(\r\n\tselect dr.*, rank() over (partition by dr.dag_id  order by id desc) as rk from dag_run dr \r\n\tinner join dags_processar dp on dp.dag_id = dr.dag_id\r\n),\r\ndags_last_execution as (\r\n\tselect * from tmp where rk = 1\r\n),\r\nlast_execution_tasks as (\t\r\n--- tasks da ultima execucao\r\n\tselect ti.dag_id \r\n\t\t  ,ti.task_id \r\n\t\t  ,ti.state \r\n\t\t  ,ti.start_date \r\n\t\t  ,round(EXTRACT(EPOCH FROM (coalesce(ti.end_date, current_timestamp) - ti.start_date ))) as last_duration \r\n\tfrom dags_last_execution dle \r\n\tinner join task_instance ti on dle.dag_id = ti.dag_id\r\n),\r\ntemp_last_execution_rules as (\r\n\tselect let.dag_id, let.task_id, let.state,\r\n\t\tcase when  let.last_duration> 900 and let.last_duration >= ta.avg_duration_seconds*1.3 and total_execution_times > 10 then 'CRITICAL'\r\n                     when  let.last_duration> 180 and let.last_duration >= ta.avg_duration_seconds*1.3 and total_execution_times > 10 then 'WARNING'\r\n\t\t     \t\telse 'OK'\r\n\t\tend message,\r\n\t\tlet.last_duration,\r\n\t\tta.avg_duration_seconds,\r\n\t\ttotal_execution_times,\r\n\t\tcase when  let.state = 'success' then ta.avg_duration_seconds- let.last_duration  else 0 end dif_between_avg_and_last\r\n\tfrom last_execution_tasks let \r\n\tleft join task_avg ta on let.dag_id = ta.dag_id and let.task_id = ta.task_id)\r\n--- ultima execuçao status das tasks\r\nselect ti.dag_id, \r\n\t    sum(avg_duration_seconds)   FILTER (WHERE ti.state = 'success') / sum(avg_duration_seconds) as Percentual\r\n\t    --  sum(avg_duration_seconds)   FILTER (WHERE ti.state = 'success') / sum(avg_duration_seconds) as percentual_conclusao_num\r\nfrom dags_last_execution dle \r\ninner join temp_last_execution_rules ti on dle.dag_id = ti.dag_id \r\ngroup by ti.dag_id, dle.start_date,  dle.state",
                    "refId": "A",
                    "select": [
                        [
                            {
                                "params": [
                                    "duration"
                                ],
                                "type": "column"
                            }
                        ]
                    ],
                    "sql": {
                        "columns": [
                            {
                                "parameters": [],
                                "type": "function"
                            }
                        ],
                        "groupBy": [
                            {
                                "property": {
                                    "type": "string"
                                },
                                "type": "groupBy"
                            }
                        ],
                        "limit": 50
                    },
                    "table": "task_instance",
                    "timeColumn": "execution_date",
                    "timeColumnType": "timestamp",
                    "where": [
                        {
                            "name": "$__timeFilter",
                            "params": [],
                            "type": "macro"
                        }
                    ]
                }
            ],
            "title": "전체 완료율",
            "type": "bargauge"
        },
        {
            "datasource": {
                "type": "postgres",
                "uid": "PFAE57465A1C8801A"
            },
            "fieldConfig": {
                "defaults": {
                    "color": {
                        "mode": "thresholds"
                    },
                    "custom": {
                        "align": "center",
                        "cellOptions": {
                            "type": "auto"
                        },
                        "inspect": false
                    },
                    "decimals": 0,
                    "displayName": "",
                    "mappings": [],
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "green",
                                "value": null
                            },
                            {
                                "color": "red",
                                "value": 80
                            }
                        ]
                    },
                    "unit": "none"
                },
                "overrides": [
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "percentual_conclusao"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "작업 완료 비율"
                            },
                            {
                                "id": "unit",
                                "value": "none"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "links",
                                "value": [
                                    {
                                        "targetBlank": false,
                                        "title": "",
                                        "url": ""
                                    }
                                ]
                            },
                            {
                                "id": "custom.cellOptions",
                                "value": {
                                    "type": "color-text"
                                }
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "thresholds",
                                "value": {
                                    "mode": "absolute",
                                    "steps": [
                                        {
                                            "color": "#F2CC0C",
                                            "value": null
                                        },
                                        {
                                            "color": "#37872D",
                                            "value": 1
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "start_date"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "시작 일자"
                            },
                            {
                                "id": "unit",
                                "value": "time: YYYY-MM-DD"
                            },
                            {
                                "id": "custom.align",
                                "value": "left"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "dag_id"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "DAG 이름"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "state"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "상태"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "percentual_conclusao_num"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "작업 완료 백분율"
                            },
                            {
                                "id": "unit",
                                "value": "percentunit"
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "total_tasks"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "전체 작업 개수"
                            },
                            {
                                "id": "unit",
                                "value": "none"
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "running"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "실행 중"
                            },
                            {
                                "id": "unit",
                                "value": "none"
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "thresholds",
                                "value": {
                                    "mode": "absolute",
                                    "steps": [
                                        {
                                            "color": "rgba(245, 54, 54, 0.9)",
                                            "value": null
                                        },
                                        {
                                            "color": "#E0B400"
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "success"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "완료된 작업"
                            },
                            {
                                "id": "unit",
                                "value": "none"
                            },
                            {
                                "id": "custom.cellOptions",
                                "value": {
                                    "type": "color-background"
                                }
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "thresholds",
                                "value": {
                                    "mode": "absolute",
                                    "steps": [
                                        {
                                            "color": "rgba(50, 172, 45, 0.97)",
                                            "value": null
                                        },
                                        {
                                            "color": "#E0B400",
                                            "value": 150
                                        },
                                        {
                                            "color": "rgba(245, 54, 54, 0.9)",
                                            "value": 200
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "failed"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "실패한 작업"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "links",
                                "value": [
                                    {
                                        "targetBlank": false,
                                        "title": "",
                                        "url": ""
                                    }
                                ]
                            },
                            {
                                "id": "custom.cellOptions",
                                "value": {
                                    "type": "color-background"
                                }
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "thresholds",
                                "value": {
                                    "mode": "absolute",
                                    "steps": [
                                        {
                                            "color": "#37872D",
                                            "value": null
                                        },
                                        {
                                            "color": "#C4162A",
                                            "value": 1
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "other_status"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "Others Status"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "custom.cellOptions",
                                "value": {
                                    "type": "color-background"
                                }
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "thresholds",
                                "value": {
                                    "mode": "absolute",
                                    "steps": [
                                        {
                                            "color": "rgba(50, 172, 45, 0.97)",
                                            "value": null
                                        },
                                        {
                                            "color": "#E02F44",
                                            "value": 2
                                        },
                                        {
                                            "color": "rgba(245, 54, 54, 0.9)",
                                            "value": 10
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "waring"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "경고"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "custom.align"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "critical"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "심각한 오류"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "custom.align"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "failed2"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "Status"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "custom.cellOptions",
                                "value": {
                                    "type": "color-background"
                                }
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "thresholds",
                                "value": {
                                    "mode": "absolute",
                                    "steps": [
                                        {
                                            "color": "rgba(245, 54, 54, 0.9)",
                                            "value": null
                                        },
                                        {
                                            "color": "#37872D",
                                            "value": 0
                                        },
                                        {
                                            "color": "#C4162A",
                                            "value": 1
                                        }
                                    ]
                                }
                            }
                        ]
                    }
                ]
            },
            "gridPos": {
                "h": 6,
                "w": 24,
                "x": 0,
                "y": 10
            },
            "id": 6,
            "links": [],
            "options": {
                "cellHeight": "sm",
                "footer": {
                    "countRows": false,
                    "fields": "",
                    "reducer": [
                        "sum"
                    ],
                    "show": false
                },
                "showHeader": true,
                "sortBy": [
                    {
                        "desc": false,
                        "displayName": "DAG 이름"
                    }
                ]
            },
            "pluginVersion": "9.5.1",
            "targets": [
                {
                    "datasource": "AirflowDB",
                    "editorMode": "code",
                    "format": "table",
                    "group": [],
                    "hide": false,
                    "metricColumn": "none",
                    "rawQuery": true,
                    "rawSql": "with \ndags_processar as (\n\tselect * from public.dag where dag_id in ($Dags)),\ntask_avg as (\n\t-- media de duracao por task\n\tselect ti.dag_id, ti.task_id, round(avg(ti.duration)) avg_duration_seconds, count(1) total_execution_times \n\tfrom dags_processar dp \n\tinner join task_instance  ti on ti.dag_id  = dp.dag_id\n\twhere ti.start_date  >= start_date -  interval '60 day'\n\tand   ti.state  = 'success'\n\tgroup by ti.dag_id, ti.task_id\n\torder by 1, 2),\ntmp as(\n\tselect dr.*, rank() over (partition by dr.dag_id  order by id desc) as rk from dag_run dr \n\tinner join dags_processar dp on dp.dag_id = dr.dag_id ),\ndags_last_execution as (\n\tselect * from tmp where rk = 1),\nlast_execution_tasks as (\t\n--- tasks da ultima execucao\n\tselect ti.dag_id \n\t\t  ,ti.task_id \n\t\t  ,ti.state \n\t\t  ,ti.start_date \n\t\t  ,round(EXTRACT(EPOCH FROM (coalesce(ti.end_date, current_timestamp) - ti.start_date ))) as last_duration \n\tfrom dags_last_execution dle \n\tinner join task_instance ti on dle.dag_id = ti.dag_id),--  and ti.start_date  = dle.start_date),\ntemp_last_execution_rules as (\n\tselect let.dag_id, let.task_id, let.state,\n\t\tcase when  let.last_duration> 900 and let.last_duration >= ta.avg_duration_seconds*1.3 and total_execution_times > 10 then 'CRITICAL'\n                     when  let.last_duration> 180 and let.last_duration >= ta.avg_duration_seconds*1.3 and total_execution_times > 10 then 'WARNING'\n\t\t     \t\telse 'OK'\n\t\tend message,\n\t\tlet.last_duration,\n\t\tta.avg_duration_seconds,\n\t\ttotal_execution_times,\n\t\tcase when  let.state = 'success' then ta.avg_duration_seconds- let.last_duration  else 0 end dif_between_avg_and_last\n\tfrom last_execution_tasks let \n\tleft join task_avg ta on let.dag_id = ta.dag_id and let.task_id = ta.task_id)\n--- ultima execuçao status das tasks\nselect ti.dag_id, \n\t   dle.start_date +  interval '1 day' start_date , \n\t   dle.state,\n\t    sum(avg_duration_seconds)   FILTER (WHERE ti.state = 'success') / sum(avg_duration_seconds) as percentual_conclusao,\n\t   sum(avg_duration_seconds)   FILTER (WHERE ti.state = 'success') / sum(avg_duration_seconds) as percentual_conclusao_num,\n\t   count(1)    as total_tasks,\n\t   count(1)   FILTER (WHERE ti.state = 'running') as running,\n\t   count(1)   FILTER (WHERE ti.state = 'success') as success,\n\t   count(1)   FILTER (WHERE ti.state = 'failed') as failed,\n\t   count(1)   FILTER (WHERE ti.state = 'failed') as failed2,\n\t   count(1)   FILTER (WHERE ti.state not in ('failed', 'success' ,'failed' )    ) as other_status,\n\t   count(1)   filter (where ti.message = 'WARNING') as waring,\n\t   count(1)   filter (where ti.message = 'CRITICAL') as critical,\n\t   cast(avg(dif_between_avg_and_last) FILTER (WHERE ti.state = 'success')  as Integer) as speed\n\t \nfrom dags_last_execution dle \ninner join temp_last_execution_rules ti on dle.dag_id = ti.dag_id \ngroup by ti.dag_id, dle.start_date,  dle.state",
                    "refId": "A",
                    "select": [
                        [
                            {
                                "params": [
                                    "duration"
                                ],
                                "type": "column"
                            }
                        ]
                    ],
                    "sql": {
                        "columns": [
                            {
                                "parameters": [],
                                "type": "function"
                            }
                        ],
                        "groupBy": [
                            {
                                "property": {
                                    "type": "string"
                                },
                                "type": "groupBy"
                            }
                        ],
                        "limit": 50
                    },
                    "table": "task_instance",
                    "timeColumn": "execution_date",
                    "timeColumnType": "timestamp",
                    "where": [
                        {
                            "name": "$__timeFilter",
                            "params": [],
                            "type": "macro"
                        }
                    ]
                }
            ],
            "title": "DAG 상태",
            "transform": "table",
            "transformations": [
                {
                    "id": "merge",
                    "options": {
                        "reducers": []
                    }
                }
            ],
            "type": "table"
        },
        {
            "datasource": {
                "type": "postgres",
                "uid": "PFAE57465A1C8801A"
            },
            "fieldConfig": {
                "defaults": {
                    "color": {
                        "mode": "thresholds"
                    },
                    "custom": {
                        "align": "right",
                        "cellOptions": {
                            "type": "auto"
                        },
                        "inspect": false
                    },
                    "decimals": 2,
                    "displayName": "",
                    "mappings": [],
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "green",
                                "value": null
                            },
                            {
                                "color": "red",
                                "value": 80
                            }
                        ]
                    },
                    "unit": "short"
                },
                "overrides": [
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "start"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "Start"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "unit",
                                "value": "time: YYYY-MM-DD HH:mm:ss"
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "displayName",
                                "value": "시작 시각"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "end"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "End"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "unit",
                                "value": "time: YYYY-MM-DD HH:mm:ss"
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "displayName",
                                "value": "종료 시각"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "duration"
                        },
                        "properties": [
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "displayName",
                                "value": "소요 시간"
                            },
                            {
                                "id": "unit",
                                "value": "ms"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "avg"
                        },
                        "properties": [
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "custom.align"
                            },
                            {
                                "id": "custom.hidden",
                                "value": true
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "avg2"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "지연된 DAG alert"
                            },
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "custom.cellOptions",
                                "value": {
                                    "type": "color-background"
                                }
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "thresholds",
                                "value": {
                                    "mode": "absolute",
                                    "steps": [
                                        {
                                            "color": "#37872D",
                                            "value": null
                                        },
                                        {
                                            "color": "#F2CC0C",
                                            "value": 600
                                        },
                                        {
                                            "color": "#C4162A",
                                            "value": 700
                                        }
                                    ]
                                }
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "dag_id"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "DAG ID"
                            }
                        ]
                    }
                ]
            },
            "gridPos": {
                "h": 9,
                "w": 24,
                "x": 0,
                "y": 16
            },
            "id": 10,
            "options": {
                "cellHeight": "sm",
                "footer": {
                    "countRows": false,
                    "fields": "",
                    "reducer": [
                        "sum"
                    ],
                    "show": false
                },
                "showHeader": true
            },
            "pluginVersion": "9.5.1",
            "targets": [
                {
                    "datasource": "AirflowDB",
                    "editorMode": "code",
                    "format": "table",
                    "group": [],
                    "hide": false,
                    "metricColumn": "none",
                    "rawQuery": true,
                    "rawSql": " SELECT   dag_id\r\n       ,  MIN(start_date) AS START\r\n       ,  MAX(end_date) AS end\r\n       ,  MAX(end_date) -  MIN(start_date) AS duration\r\n       ,  AVG(duration)\r\n       ,  AVG(duration) as avg2\r\n    FROM  task_instance\r\nWHERE  \r\n  dag_id in ($Dags)\r\n     AND  state = 'success'\r\n     GROUP BY  start_date, dag_id\r\n",
                    "refId": "A",
                    "select": [
                        [
                            {
                                "params": [
                                    "duration"
                                ],
                                "type": "column"
                            }
                        ]
                    ],
                    "sql": {
                        "columns": [
                            {
                                "parameters": [],
                                "type": "function"
                            }
                        ],
                        "groupBy": [
                            {
                                "property": {
                                    "type": "string"
                                },
                                "type": "groupBy"
                            }
                        ],
                        "limit": 50
                    },
                    "table": "task_instance",
                    "timeColumn": "execution_date",
                    "timeColumnType": "timestamp",
                    "where": [
                        {
                            "name": "$__timeFilter",
                            "params": [],
                            "type": "macro"
                        }
                    ]
                }
            ],
            "title": "날짜별 실행 소요 시간",
            "transform": "table",
            "transformations": [
                {
                    "id": "merge",
                    "options": {
                        "reducers": []
                    }
                }
            ],
            "type": "table"
        },
        {
            "datasource": {
                "type": "postgres",
                "uid": "PFAE57465A1C8801A"
            },
            "fieldConfig": {
                "defaults": {
                    "color": {
                        "mode": "thresholds"
                    },
                    "custom": {
                        "align": "center",
                        "cellOptions": {
                            "type": "auto"
                        },
                        "inspect": false
                    },
                    "decimals": 0,
                    "displayName": "",
                    "mappings": [],
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "green",
                                "value": null
                            },
                            {
                                "color": "red",
                                "value": 80
                            }
                        ]
                    },
                    "unit": "short"
                },
                "overrides": [
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "last_duration"
                        },
                        "properties": [
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "links",
                                "value": [
                                    {
                                        "targetBlank": false,
                                        "title": "",
                                        "url": ""
                                    }
                                ]
                            },
                            {
                                "id": "custom.cellOptions",
                                "value": {
                                    "type": "color-text"
                                }
                            },
                            {
                                "id": "thresholds",
                                "value": {
                                    "mode": "absolute",
                                    "steps": [
                                        {
                                            "color": "rgba(50, 172, 45, 0.97)",
                                            "value": null
                                        },
                                        {
                                            "color": "#C4162A",
                                            "value": 900
                                        }
                                    ]
                                }
                            },
                            {
                                "id": "displayName",
                                "value": "마지막 소요 시간"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "state"
                        },
                        "properties": [
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "custom.align"
                            },
                            {
                                "id": "displayName",
                                "value": "상태"
                            }
                        ]
                    }
                ]
            },
            "gridPos": {
                "h": 7,
                "w": 24,
                "x": 0,
                "y": 25
            },
            "id": 4,
            "links": [],
            "options": {
                "cellHeight": "sm",
                "footer": {
                    "countRows": false,
                    "fields": "",
                    "reducer": [
                        "sum"
                    ],
                    "show": false
                },
                "showHeader": true
            },
            "pluginVersion": "9.5.1",
            "targets": [
                {
                    "datasource": "AirflowDB",
                    "editorMode": "code",
                    "format": "table",
                    "group": [],
                    "hide": false,
                    "metricColumn": "none",
                    "rawQuery": true,
                    "rawSql": "with \r\ndags_processar as (\r\n\tselect * from public.dag\r\n\twhere dag_id  in ($Dags)\r\n),\r\ntask_avg as (\r\n\t-- media de duracao por task\r\n\tselect ti.dag_id, ti.task_id, round(avg(ti.duration)) avg_duration_seconds, count(1) total_execution_times \r\n\tfrom dags_processar dp \r\n\tinner join task_instance  ti on ti.dag_id  = dp.dag_id\r\n\twhere ti.start_date  >= start_date -  interval '7 day'\r\n\tand   ti.state  = 'success'\r\n\tgroup by ti.dag_id, ti.task_id\r\n\torder by 1, 2\r\n),\r\ntmp as(\r\n\tselect dr.*, rank() over (partition by dr.dag_id  order by id desc) as rk from dag_run dr \r\n\tinner join dags_processar dp on dp.dag_id = dr.dag_id\r\n),\r\ndags_last_execution as (\r\n\tselect * from tmp where rk = 1\r\n),\r\nlast_execution_tasks as (\t\r\n\t--- 마지막 실행 작업\r\n\tselect ti.dag_id\r\n\t\t  ,ti.task_id\r\n\t\t  ,ti.state\r\n\t\t  ,ti.start_date\r\n\t\t  ,round(EXTRACT(EPOCH FROM (coalesce(ti.end_date, current_timestamp) - ti.start_date ))) as last_duration\r\n\tfrom dags_last_execution dle \r\n\tinner join task_instance ti on dle.dag_id = ti.dag_id--  and ti.start_date  = dle.start_date\r\n),\r\ntemp_last_execution_rules as (\r\n\tselect let.dag_id, let.task_id, let.state,\r\n\t\t--case when  let.last_duration> 900 and let.last_duration >= ta.avg_duration_seconds*1.3 and total_execution_times > 10 then 'CRITICAL' \r\n\t--\t\t when  let.last_duration> 180 and let.last_duration >= ta.avg_duration_seconds*1.3 and total_execution_times > 10 then 'WARNING'\r\n\t--\telse 'OK'\r\n\t--\tend message,\r\n\t\tlet.last_duration,\r\n\t\tta.avg_duration_seconds,\r\n\t\ttotal_execution_times,\r\n\t\tcase when  let.state = 'success' then ta.avg_duration_seconds- let.last_duration  else 0 end dif_between_avg_and_last\r\n\tfrom last_execution_tasks let \r\n\tleft join task_avg ta on let.dag_id = ta.dag_id and let.task_id = ta.task_id)\r\n-- select ti.dag_id, ti.start_date s, dle.start_date w from dags_last_execution dle inner join task_instance ti on dle.dag_id = ti.dag_id\r\nselect * from temp_last_execution_rules\r\nwhere dag_id in ($Dags)",
                    "refId": "A",
                    "select": [
                        [
                            {
                                "params": [
                                    "duration"
                                ],
                                "type": "column"
                            }
                        ]
                    ],
                    "sql": {
                        "columns": [
                            {
                                "parameters": [],
                                "type": "function"
                            }
                        ],
                        "groupBy": [
                            {
                                "property": {
                                    "type": "string"
                                },
                                "type": "groupBy"
                            }
                        ],
                        "limit": 50
                    },
                    "table": "task_instance",
                    "timeColumn": "execution_date",
                    "timeColumnType": "timestamp",
                    "where": [
                        {
                            "name": "$__timeFilter",
                            "params": [],
                            "type": "macro"
                        }
                    ]
                }
            ],
            "title": "작업",
            "transform": "table",
            "transformations": [
                {
                    "id": "seriesToRows",
                    "options": {
                        "reducers": []
                    }
                }
            ],
            "type": "table"
        },
        {
            "datasource": {
                "type": "postgres",
                "uid": "PFAE57465A1C8801A"
            },
            "fieldConfig": {
                "defaults": {
                    "color": {
                        "mode": "thresholds"
                    },
                    "custom": {
                        "align": "auto",
                        "cellOptions": {
                            "type": "auto"
                        },
                        "inspect": false
                    },
                    "mappings": [],
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "green",
                                "value": null
                            },
                            {
                                "color": "red",
                                "value": 80
                            }
                        ]
                    }
                },
                "overrides": [
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "data"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "날짜"
                            },
                            {
                                "id": "unit",
                                "value": "time: YYYY-MM-DD HH:mm:ss"
                            },
                            {
                                "id": "custom.align"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "log"
                        },
                        "properties": [
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "links",
                                "value": [
                                    {
                                        "targetBlank": true,
                                        "title": "",
                                        "url": "${__cell:task_id}"
                                    }
                                ]
                            },
                            {
                                "id": "custom.align",
                                "value": "right"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "status_job"
                        },
                        "properties": [
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "custom.cellOptions",
                                "value": {
                                    "type": "color-text"
                                }
                            },
                            {
                                "id": "custom.align",
                                "value": "center"
                            },
                            {
                                "id": "thresholds",
                                "value": {
                                    "mode": "absolute",
                                    "steps": [
                                        {
                                            "color": "rgba(50, 172, 45, 0.97)",
                                            "value": null
                                        },
                                        {
                                            "color": "#C4162A",
                                            "value": 1
                                        }
                                    ]
                                }
                            },
                            {
                                "id": "custom.width",
                                "value": 106
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "name_dag"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "DAG 이름"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "name_task_airflow"
                        },
                        "properties": [
                            {
                                "id": "custom.width",
                                "value": 167
                            },
                            {
                                "id": "displayName",
                                "value": "Task 이름"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "_time"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "시간"
                            }
                        ]
                    }
                ]
            },
            "gridPos": {
                "h": 5,
                "w": 24,
                "x": 0,
                "y": 32
            },
            "id": 2,
            "links": [],
            "options": {
                "cellHeight": "sm",
                "footer": {
                    "countRows": false,
                    "fields": "",
                    "reducer": [
                        "sum"
                    ],
                    "show": false
                },
                "showHeader": true,
                "sortBy": []
            },
            "pluginVersion": "9.5.1",
            "targets": [
                {
                    "datasource": "AirflowDB",
                    "editorMode": "code",
                    "format": "table",
                    "group": [],
                    "hide": false,
                    "metricColumn": "none",
                    "rawQuery": true,
                    "rawSql": "SELECT \r\n dr.dag_id as NAME_DAG\r\n,LEFT(RIGHT(dr.run_id,25),10)  AS DATA\r\n,LEFT(RIGHT(dr.run_id,14),8)  AS _time\r\n,ti.task_id as NAME_TASK_AIRFLOW\r\n-- ,ti.state as STATUS_JOB\r\n,case when ti.state = 'failed' then 1 else 0 end STATUS_JOB\r\n,concat('http://localhost:7001/admin/taskinstance/?flt0_task_id_contains=') as log\r\nFROM dag_run as dr\r\nINNER JOIN\r\n(\r\n  SELECT dag_id, task_id, state, start_date\r\n  FROM task_instance\r\n  WHERE state = 'failed' and dag_id in ($Dags) --and start_date > now() - interval '7 day'\r\n) as ti\r\nON dr.dag_id = ti.dag_id --AND dr.start_date = ti.start_date\r\norder by dr.dag_id, dr.start_date\r\n",
                    "refId": "A",
                    "select": [
                        [
                            {
                                "params": [
                                    "duration"
                                ],
                                "type": "column"
                            }
                        ]
                    ],
                    "sql": {
                        "columns": [
                            {
                                "parameters": [],
                                "type": "function"
                            }
                        ],
                        "groupBy": [
                            {
                                "property": {
                                    "type": "string"
                                },
                                "type": "groupBy"
                            }
                        ],
                        "limit": 50
                    },
                    "table": "task_instance",
                    "timeColumn": "execution_date",
                    "timeColumnType": "timestamp",
                    "where": [
                        {
                            "name": "$__timeFilter",
                            "params": [],
                            "type": "macro"
                        }
                    ]
                }
            ],
            "title": "실패한 작업",
            "transformations": [
                {
                    "id": "merge",
                    "options": {
                        "reducers": []
                    }
                }
            ],
            "type": "table"
        },
        {
            "datasource": {
                "type": "postgres",
                "uid": "PFAE57465A1C8801A"
            },
            "fieldConfig": {
                "defaults": {
                    "color": {
                        "mode": "thresholds"
                    },
                    "custom": {
                        "align": "center",
                        "cellOptions": {
                            "type": "auto"
                        },
                        "inspect": false
                    },
                    "decimals": 2,
                    "displayName": "",
                    "mappings": [],
                    "thresholds": {
                        "mode": "absolute",
                        "steps": [
                            {
                                "color": "green",
                                "value": null
                            },
                            {
                                "color": "red",
                                "value": 80
                            }
                        ]
                    },
                    "unit": "short"
                },
                "overrides": [
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "start_date"
                        },
                        "properties": [
                            {
                                "id": "displayName",
                                "value": "시각"
                            },
                            {
                                "id": "unit",
                                "value": "time: YYYY-MM-DD HH:mm:ss"
                            },
                            {
                                "id": "custom.align"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "start"
                        },
                        "properties": [
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "unit",
                                "value": "time: YYYY-MM-DD HH:mm:ss"
                            },
                            {
                                "id": "custom.align"
                            },
                            {
                                "id": "displayName",
                                "value": "시작 시각"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "end"
                        },
                        "properties": [
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "unit",
                                "value": "time: YYYY-MM-DD HH:mm:ss"
                            },
                            {
                                "id": "custom.align"
                            },
                            {
                                "id": "displayName",
                                "value": "종료 시각"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "duration"
                        },
                        "properties": [
                            {
                                "id": "unit",
                                "value": "none"
                            },
                            {
                                "id": "custom.align",
                                "value": "left"
                            },
                            {
                                "id": "displayName",
                                "value": "소요 시간"
                            }
                        ]
                    },
                    {
                        "matcher": {
                            "id": "byName",
                            "options": "start_date"
                        },
                        "properties": [
                            {
                                "id": "unit",
                                "value": "short"
                            },
                            {
                                "id": "decimals",
                                "value": 2
                            },
                            {
                                "id": "unit",
                                "value": "time: YYYY-MM-DD HH:mm:ss"
                            },
                            {
                                "id": "custom.align"
                            },
                            {
                                "id": "displayName",
                                "value": "실행 시각"
                            }
                        ]
                    }
                ]
            },
            "gridPos": {
                "h": 8,
                "w": 24,
                "x": 0,
                "y": 37
            },
            "id": 8,
            "options": {
                "cellHeight": "sm",
                "footer": {
                    "countRows": false,
                    "fields": "",
                    "reducer": [
                        "sum"
                    ],
                    "show": false
                },
                "showHeader": true
            },
            "pluginVersion": "9.5.1",
            "targets": [
                {
                    "datasource": "AirflowDB",
                    "editorMode": "code",
                    "format": "table",
                    "group": [],
                    "hide": false,
                    "metricColumn": "none",
                    "rawQuery": true,
                    "rawSql": " SELECT  start_date\r\n      , task_id\r\n       ,  MIN(start_date) AS start\r\n       ,  MAX(end_date) AS end\r\n       ,  MAX(end_date) - MIN(start_date) AS duration\r\n    FROM  task_instance\r\n   WHERE  dag_id in ($Dags)\r\n     AND  state = 'success'\r\nGROUP BY  start_date, TASK_ID\r\nORDER BY  start_date DESC",
                    "refId": "A",
                    "select": [
                        [
                            {
                                "params": [
                                    "duration"
                                ],
                                "type": "column"
                            }
                        ]
                    ],
                    "sql": {
                        "columns": [
                            {
                                "parameters": [],
                                "type": "function"
                            }
                        ],
                        "groupBy": [
                            {
                                "property": {
                                    "type": "string"
                                },
                                "type": "groupBy"
                            }
                        ],
                        "limit": 50
                    },
                    "table": "task_instance",
                    "timeColumn": "execution_date",
                    "timeColumnType": "timestamp",
                    "where": [
                        {
                            "name": "$__timeFilter",
                            "params": [],
                            "type": "macro"
                        }
                    ]
                }
            ],
            "title": "작업별 Duration",
            "transform": "table",
            "transformations": [
                {
                    "id": "merge",
                    "options": {
                        "reducers": []
                    }
                }
            ],
            "type": "table"
        }
    ],
    "refresh": "",
    "schemaVersion": 38,
    "style": "dark",
    "tags": [],
    "templating": {
        "list": [
            {
                "current": {
                    "selected": false,
                    "text": "All",
                    "value": "$__all"
                },
                "datasource": {
                    "type": "postgres",
                    "uid": "PFAE57465A1C8801A"
                },
                "definition": "select dag_id from public.dag ",
                "hide": 0,
                "includeAll": true,
                "label": "DAG 검색",
                "multi": true,
                "name": "Dags",
                "options": [],
                "query": "select dag_id from public.dag ",
                "refresh": 1,
                "regex": "",
                "skipUrlSync": false,
                "sort": 1,
                "tagValuesQuery": "",
                "tagsQuery": "",
                "type": "query",
                "useTags": false
            }
        ]
    },
    "time": {
        "from": "now-2d",
        "to": "now"
    },
    "timepicker": {
        "refresh_intervals": [
            "5s",
            "10s",
            "30s",
            "1m",
            "5m",
            "15m",
            "30m",
            "1h",
            "2h",
            "1d"
        ]
    },
    "timezone": "",
    "title": "Airflow monitoring",
    "uid": "Airflow_Monitor",
    "version": 5,
    "weekStart": ""
}